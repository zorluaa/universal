local settings = getgenv().settings
if not settings then return end

local players = game:GetService("Players")
local runService = game:GetService("RunService")
local userInputService = game:GetService("UserInputService")
local localPlayer = players.LocalPlayer

local isEnabled = settings.HBEEnabled -- Stores current state

local function modifyHitboxes(state)
    for _, player in ipairs(players:GetPlayers()) do
        if player ~= localPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local rootPart = player.Character.HumanoidRootPart
            if state then
                rootPart.Size = Vector3.new(settings.HBESize, settings.HBESize, settings.HBESize)
                rootPart.Transparency = settings.HBETransparency
                rootPart.Material = Enum.Material.Neon
                rootPart.Color = settings.HBEColor
            else
                -- Reset to default hitbox size when disabled
                rootPart.Size = Vector3.new(2, 2, 1)
                rootPart.Transparency = 0
                rootPart.Material = Enum.Material.Plastic
                rootPart.Color = Color3.fromRGB(255, 255, 255)
            end
        end
    end
end

-- Toggle function for keybind
userInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == settings.HBEToggleKey then
        isEnabled = not isEnabled
        settings.HBEEnabled = isEnabled
        print("Hitbox Expander:", isEnabled and "Enabled" or "Disabled")
        modifyHitboxes(isEnabled) -- Apply changes immediately
    end
end)

-- Continuously apply modifications if enabled
runService.RenderStepped:Connect(function()
    if isEnabled then
        modifyHitboxes(true)
    end
end)
